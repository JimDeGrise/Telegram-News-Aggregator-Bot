# Документация по новым хендлерам

## Структура

Проект теперь имеет следующую структуру хендлеров:

```
project/
  main.py (обновлен)
  handlers/
    __init__.py
    antiflood.py     # Антифлуд защита
    content_filter.py # Фильтрация контента
    commands.py      # Команды /start, /ping  
    help.py         # Команда /help
```

## Функциональность

### 1. Антифлуд защита (handlers/antiflood.py)

**Возможности:**
- Ограничение количества сообщений в временном окне
- Прогрессивные предупреждения перед мутом
- Автоматический мут пользователей при превышении лимитов
- Команды не подвергаются антифлуду
- Админ-байпас

**Настройки в config.toml:**
```toml
[antiflood]
message_limit = 5        # Лимит сообщений в временном окне
time_window = 60         # Временное окно в секундах  
warning_threshold = 3    # Количество предупреждений до мута
mute_duration = 300      # Длительность мута в секундах
```

### 2. Фильтр контента (handlers/content_filter.py)

**Возможности:**
- Фильтрация по запрещенным словам
- Фильтрация по паттернам ссылок (поддержка regex)
- Проверка валидности команд
- Команды не подвергаются фильтрации контента
- Админ-байпас

**Настройки в config.toml:**
```toml
[content_filter]
forbidden_words = ["спам", "плохое"]           # Список запрещенных слов
forbidden_link_patterns = ["badsite\\.com"]   # Regex паттерны для ссылок
```

### 3. Команды (handlers/commands.py)

**Команды:**
- `/start` - доступна только администратору
- `/ping` - проверка работы бота (доступна всем)

### 4. Справка (handlers/help.py)

**Команды:**
- `/help` - показывает полную справку по командам

## Конфигурация

### Настройка администратора

В config.toml добавьте:
```toml
[telegram]
bot_token = "YOUR_BOT_TOKEN"
chat_id = "YOUR_CHAT_ID"
admin_user_id = "ADMIN_USER_ID"  # ID администратора
```

## Порядок обработки

Middleware и роутеры подключаются в следующем порядке:

1. **AntiFloodMiddleware** - проверка лимитов сообщений
2. **ContentFilterMiddleware** - фильтрация контента
3. **Commands Router** - обработка команд /start, /ping
4. **Help Router** - обработка команды /help
5. **Main Router** - остальные команды из bot_commands.py

## Ключевые особенности

### Обход фильтров для команд

- Команды (сообщения, начинающиеся с `/`) не подвергаются антифлуду
- Команды не подвергаются фильтрации контента по словам/ссылкам
- Проверяется только валидность самих команд

### Админ-байпас

- Администратор проходит все фильтры без ограничений
- Настраивается через `admin_user_id` в конфигурации
- Применяется ко всем middleware

### Безопасность

- После превышения порога антифлуда не запускается новый круг предупреждений
- Мут автоматически снимается по истечении времени
- Неизвестные команды блокируются с информативным сообщением

## Сохранение существующей функциональности

Вся существующая функциональность бота сохранена:
- Все команды из bot_commands.py работают как прежде
- RSS агрегация работает без изменений
- Поиск и навигация работают как прежде
- Архивация и статистика работают как прежде

## Тестирование

Для тестирования функциональности запустите:
```bash
python test_handlers.py
```

Этот скрипт проверяет:
- Корректность импортов
- Настройку конфигурации
- Базовую логику middleware